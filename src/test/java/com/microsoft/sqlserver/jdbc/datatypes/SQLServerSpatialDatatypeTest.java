/*
 * Microsoft JDBC Driver for SQL Server
 * 
 * Copyright(c) Microsoft Corporation All rights reserved.
 * 
 * This program is made available under the terms of the MIT License. See the LICENSE file in the project root for more information.
 */
package com.microsoft.sqlserver.jdbc.datatypes;

import static org.junit.jupiter.api.Assertions.assertEquals;

import java.io.IOException;
import java.sql.DriverManager;
import java.sql.ParameterMetaData;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import org.apache.commons.codec.DecoderException;
import org.apache.commons.codec.binary.Hex;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.junit.platform.runner.JUnitPlatform;
import org.junit.runner.RunWith;

import com.microsoft.sqlserver.jdbc.Geography;
import com.microsoft.sqlserver.jdbc.Geometry;
import com.microsoft.sqlserver.jdbc.SQLServerConnection;
import com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement;
import com.microsoft.sqlserver.jdbc.SQLServerResultSet;
import com.microsoft.sqlserver.testframework.AbstractTest;
import com.microsoft.sqlserver.testframework.Utils;

/**
 * Test Geometry / Geography classes
 *
 */
@RunWith(JUnitPlatform.class)
public class SQLServerSpatialDatatypeTest extends AbstractTest  {

    static SQLServerConnection con = null;
    static Statement stmt = null;
    static String geomTableName = "geometryTestTable";
    static String geogTableName = "geographyTestTable";
    static String spatialDatatypeTableName = "spatialDatatypeTestTable";
    static SQLServerPreparedStatement pstmt = null;
    static SQLServerResultSet rs = null;
    static boolean isDenaliOrLater = false;

    @Test
    public void testPointWkb() throws DecoderException {
        String geoWKT = "POINT(3 40 5 6)";
        byte[] geomWKB = Hex.decodeHex("00000000010F0000000000000840000000000000444000000000000014400000000000001840".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E6100000010F0000000000004440000000000000084000000000000014400000000000001840".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testLineStringWkb() throws DecoderException {
        String geoWKT = "LINESTRING(1 0, 0 1, -1 0)";
        byte[] geomWKB = Hex.decodeHex("00000000010403000000000000000000F03F00000000000000000000000000000000000000000000F03F000000000000F0BF000000000000000001000000010000000001000000FFFFFFFF0000000002".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E61000000104030000000000000000000000000000000000F03F000000000000F03F00000000000000000000000000000000000000000000F0BF01000000010000000001000000FFFFFFFF0000000002".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testPolygonWkb() throws DecoderException {
        String geoWKT = "POLYGON((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1))";
        byte[] geomWKB = Hex.decodeHex("000000000104090000000000000000000000000000000000000000000000000000000000000000000840000000000000084000000000000008400000000000000840000000000000000000000000000000000000000000000000000000000000F03F000000000000F03F000000000000F03F00000000000000400000000000000040000000000000F03F000000000000F03F000000000000F03F020000000200000000000500000001000000FFFFFFFF0000000003".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E61000000200090000000000000000000000000000000000000000000000000008400000000000000000000000000000084000000000000008400000000000000000000000000000084000000000000000000000000000000000000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F020000000100000000010500000001000000FFFFFFFF0000000003".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testMultiPointWkb() throws DecoderException {
        String geoWKT = "MULTIPOINT((2 3), (7 8 9.5))";
        byte[] geomWKB = Hex.decodeHex("00000000010502000000000000000000004000000000000008400000000000001C400000000000002040000000000000F8FF0000000000002340020000000100000000010100000003000000FFFFFFFF0000000004000000000000000001000000000100000001".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E61000000105020000000000000000000840000000000000004000000000000020400000000000001C40000000000000F8FF0000000000002340020000000100000000010100000003000000FFFFFFFF0000000004000000000000000001000000000100000001".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testMultiLineStringWkb() throws DecoderException {
        String geoWKT = "MULTILINESTRING((0 2, 1 1), (1 0, 1 1))";
        byte[] geomWKB = Hex.decodeHex("0000000001040400000000000000000000000000000000000040000000000000F03F000000000000F03F000000000000F03F0000000000000000000000000000F03F000000000000F03F020000000100000000010200000003000000FFFFFFFF0000000005000000000000000002000000000100000002".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E610000001040400000000000000000000400000000000000000000000000000F03F000000000000F03F0000000000000000000000000000F03F000000000000F03F000000000000F03F020000000100000000010200000003000000FFFFFFFF0000000005000000000000000002000000000100000002".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testMultiPolygonWkb() throws DecoderException {
        String geoWKT = "MULTIPOLYGON(((1 1, 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";
        byte[] geomWKB = Hex.decodeHex("0000000001010D000000000000000000F03F000000000000F03F000000000000F03F00000000000000400000000000000040000000000000F03F000000000000F03F000000000000F03F000000000000000000000000000000000000000000000000000000000000084000000000000008400000000000000840000000000000084000000000000000000000000000000000000000000000000000000000000022400000000000002240000000000000224000000000000024400000000000002440000000000000224000000000000022400000000000002240000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF0000000000001C40000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF0300000002000000000004000000020900000003000000FFFFFFFF0000000006000000000000000003000000000200000003".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E610000002010D000000000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F000000000000000000000000000000000000000000000840000000000000000000000000000008400000000000000840000000000000000000000000000008400000000000000000000000000000000000000000000022400000000000002240000000000000244000000000000022400000000000002240000000000000244000000000000022400000000000002240000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF0000000000001C40000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF0300000001000000000104000000010900000003000000FFFFFFFF0000000006000000000000000003000000000200000003".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testGeometryCollectionWkb() throws DecoderException {
        String geoWKT = "GEOMETRYCOLLECTION(POINT(3 3 1), LINESTRING(1 0, 0 1, -1 0), CIRCULARSTRING(1 3, 3 5, 4 7, 7 3, 1 3), POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2), (0 0 2, 1 10 3, 1 0 4, 0 0 2), (0 0 2, 1 10 3, 1 0 4, 0 0 2)), MULTIPOINT((2 3), (7 8 9.5)), MULTILINESTRING((0 2, 1 1), (1 0, 1 1)), MULTIPOLYGON(((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1)), ((9 9, 9 10, 10 9, 9 9))), COMPOUNDCURVE(CIRCULARSTRING(1 0 3, 0 1 3, 9 6 3, 8 7 3, -1 0 3), CIRCULARSTRING(-1 0 3, 7 9 3, -10 2 3), (-10 2 3, 77 77 77, 88 88 88, 2 6 4), (2 6 4, 3 3 6, 7 7 1)), CURVEPOLYGON((0 0, 0 0, 0 0, 0 0), COMPOUNDCURVE((0 -23.43778, 0 23.43778), CIRCULARSTRING(0 23.43778, -45 -23.43778, 0 -23.43778)), COMPOUNDCURVE((0 -23.43778, 7 7, 0 23.43778), CIRCULARSTRING(0 23.43778, 8 8, 8 8, -45 23.43778, -90 23.43778), (-90 23.43778, -90 -23.43778), CIRCULARSTRING(-90 -23.43778, -45 -23.43778, 0 -23.43778))), POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2)))";
        byte[] geomWKB = Hex.decodeHex("0100000002014A00000000000000000008400000000000000840000000000000F03F00000000000000000000000000000000000000000000F03F000000000000F0BF0000000000000000000000000000F03F00000000000008400000000000000840000000000000144000000000000010400000000000001C400000000000001C400000000000000840000000000000F03F000000000000084000000000000000000000000000000000000000000000F03F0000000000002440000000000000F03F00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F03F0000000000002440000000000000F03F00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F03F0000000000002440000000000000F03F000000000000000000000000000000000000000000000000000000000000004000000000000008400000000000001C40000000000000204000000000000000000000000000000040000000000000F03F000000000000F03F000000000000F03F0000000000000000000000000000F03F000000000000F03F0000000000000000000000000000000000000000000000000000000000000840000000000000084000000000000008400000000000000840000000000000000000000000000000000000000000000000000000000000F03F000000000000F03F000000000000F03F00000000000000400000000000000040000000000000F03F000000000000F03F000000000000F03F00000000000022400000000000002240000000000000224000000000000024400000000000002440000000000000224000000000000022400000000000002240000000000000F03F00000000000000000000000000000000000000000000F03F0000000000002240000000000000184000000000000020400000000000001C40000000000000F0BF00000000000000000000000000001C40000000000000224000000000000024C00000000000000040000000000040534000000000004053400000000000005640000000000000564000000000000000400000000000001840000000000000084000000000000008400000000000001C400000000000001C40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C7D79E59127037C00000000000000000C7D79E591270374000000000008046C0C7D79E59127037C00000000000000000C7D79E59127037C00000000000000000C7D79E59127037C00000000000001C400000000000001C400000000000000000C7D79E5912703740000000000000204000000000000020400000000000002040000000000000204000000000008046C0C7D79E591270374000000000008056C0C7D79E591270374000000000008056C0C7D79E59127037C000000000008046C0C7D79E59127037C00000000000000000C7D79E59127037C000000000000000000000000000000000000000000000F03F0000000000002440000000000000F03F000000000000000000000000000000000000000000000000000000000000F03F000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000004000000000000008400000000000001040000000000000004000000000000000400000000000000840000000000000104000000000000000400000000000000040000000000000084000000000000010400000000000000040000000000000F8FF0000000000002340000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF00000000000008400000000000000840000000000000084000000000000008400000000000000840000000000000084000000000000008400000000000405340000000000000564000000000000010400000000000001840000000000000F03F000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF0000000000000040000000000000084000000000000010400000000000000040120000000100000000010100000002040000000109000000010D00000001110000000115000000011600000001170000000119000000011B00000001200000000124000000032800000001340000000338000000033C000000014600000011000000FFFFFFFF0000000007000000000000000001000000000100000002000000000200000008000000000300000003000000000600000004050000000600000001050000000700000001000000000800000005080000000800000002080000000900000002000000000A000000060B0000000A000000030B0000000C00000003000000000D00000009000000000E0000000A0000000011000000031000000003010302000002000203020003010203".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E610000002214A000000000000000000084000000000000008400000000000000000000000000000F03F000000000000F03F00000000000000000000000000000000000000000000F0BF0000000000000840000000000000F03F000000000000144000000000000008400000000000001C40000000000000104000000000000008400000000000001C400000000000000840000000000000F03F000000000000000000000000000000000000000000002440000000000000F03F0000000000000000000000000000F03F00000000000000000000000000000000000000000000000000000000000000000000000000002440000000000000F03F0000000000000000000000000000F03F00000000000000000000000000000000000000000000000000000000000000000000000000002440000000000000F03F0000000000000000000000000000F03F000000000000000000000000000000000000000000000840000000000000004000000000000020400000000000001C4000000000000000400000000000000000000000000000F03F000000000000F03F0000000000000000000000000000F03F000000000000F03F000000000000F03F0000000000000000000000000000000000000000000008400000000000000000000000000000084000000000000008400000000000000000000000000000084000000000000000000000000000000000000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F000000000000224000000000000022400000000000002440000000000000224000000000000022400000000000002440000000000000224000000000000022400000000000000000000000000000F03F000000000000F03F0000000000000000000000000000184000000000000022400000000000001C4000000000000020400000000000000000000000000000F0BF00000000000022400000000000001C40000000000000004000000000000024C0000000000040534000000000004053400000000000005640000000000000564000000000000018400000000000000040000000000000084000000000000008400000000000001C400000000000001C4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C7D79E59127037C00000000000000000C7D79E59127037400000000000000000C7D79E59127037C000000000008046C0C7D79E59127037C00000000000000000C7D79E59127037C000000000000000000000000000001C400000000000001C40C7D79E591270374000000000000000000000000000002040000000000000204000000000000020400000000000002040C7D79E591270374000000000008046C0C7D79E591270374000000000008056C0C7D79E59127037C000000000008056C0C7D79E59127037C000000000008046C0C7D79E59127037C00000000000000000000000000000000000000000000000000000000000002440000000000000F03F0000000000000000000000000000F03F00000000000000000000000000000000000000000000F03F000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000004000000000000008400000000000001040000000000000004000000000000000400000000000000840000000000000104000000000000000400000000000000040000000000000084000000000000010400000000000000040000000000000F8FF0000000000002340000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF00000000000008400000000000000840000000000000084000000000000008400000000000000840000000000000084000000000000008400000000000405340000000000000564000000000000010400000000000001840000000000000F03F000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF0000000000000040000000000000084000000000000010400000000000000040120000000100000000010100000002040000000109000000010D00000001110000000115000000011600000001170000000119000000011B00000001200000000124000000032800000001340000000338000000033C000000014600000011000000FFFFFFFF0000000007000000000000000001000000000100000002000000000200000008000000000300000003000000000600000004050000000600000001050000000700000001000000000800000005080000000800000002080000000900000002000000000A000000060B0000000A000000030B0000000C00000003000000000D00000009000000000E0000000A0000000011000000031000000003010302000002000203020003010203".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testCircularStringWkb() throws DecoderException {
        String geoWKT = "CIRCULARSTRING(2 1 3 4, 1 2 3, 0 7 3, 1 0 3, 2 1 3)";
        byte[] geomWKB = Hex.decodeHex("000000000207050000000000000000000040000000000000F03F000000000000F03F000000000000004000000000000000000000000000001C40000000000000F03F00000000000000000000000000000040000000000000F03F000000000000084000000000000008400000000000000840000000000000084000000000000008400000000000001040000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF01000000020000000001000000FFFFFFFF0000000008".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E6100000020705000000000000000000F03F00000000000000400000000000000040000000000000F03F0000000000001C4000000000000000000000000000000000000000000000F03F000000000000F03F0000000000000040000000000000084000000000000008400000000000000840000000000000084000000000000008400000000000001040000000000000F8FF000000000000F8FF000000000000F8FF000000000000F8FF01000000020000000001000000FFFFFFFF0000000008".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testCompoundCurveWkb() throws DecoderException {
        String geoWKT = "COMPOUNDCURVE(CIRCULARSTRING(1 0 3, 0 1 3, 9 6 3, 8 7 3, -1 0 3), CIRCULARSTRING(-1 0 3, 7 9 3, -10 2 3), (-10 2 3, 77 77 77, 88 88 88, 2 6 4), (2 6 4, 3 3 6, 7 7 1))";
        byte[] geomWKB = Hex.decodeHex("0000000002050C000000000000000000F03F00000000000000000000000000000000000000000000F03F0000000000002240000000000000184000000000000020400000000000001C40000000000000F0BF00000000000000000000000000001C40000000000000224000000000000024C00000000000000040000000000040534000000000004053400000000000005640000000000000564000000000000000400000000000001840000000000000084000000000000008400000000000001C400000000000001C4000000000000008400000000000000840000000000000084000000000000008400000000000000840000000000000084000000000000008400000000000405340000000000000564000000000000010400000000000001840000000000000F03F01000000030000000001000000FFFFFFFF0000000009080000000301030200000200".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E610000002050C0000000000000000000000000000000000F03F000000000000F03F0000000000000000000000000000184000000000000022400000000000001C4000000000000020400000000000000000000000000000F0BF00000000000022400000000000001C40000000000000004000000000000024C0000000000040534000000000004053400000000000005640000000000000564000000000000018400000000000000040000000000000084000000000000008400000000000001C400000000000001C4000000000000008400000000000000840000000000000084000000000000008400000000000000840000000000000084000000000000008400000000000405340000000000000564000000000000010400000000000001840000000000000F03F01000000030000000001000000FFFFFFFF0000000009080000000301030200000200".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }
    
    @Test
    public void testCurvePolygonWkb() throws DecoderException {
        String geoWKT = "CURVEPOLYGON((0 0, 0 0, 0 0, 0 0), CIRCULARSTRING(1 3, 3 5, 4 7, 7 3, 1 3), COMPOUNDCURVE((0 -23.43778, 0 23.43778), CIRCULARSTRING(0 23.43778, -45 -23.43778, 0 -23.43778)), COMPOUNDCURVE((0 -23.43778, 7 7, 0 23.43778), CIRCULARSTRING(0 23.43778, 8 8, 8 8, -45 23.43778, -90 23.43778), (-90 23.43778, -90 -23.43778), CIRCULARSTRING(-90 -23.43778, -45 -23.43778, 0 -23.43778)))";
        byte[] geomWKB = Hex.decodeHex("0A00000002001700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F03F00000000000008400000000000000840000000000000144000000000000010400000000000001C400000000000001C400000000000000840000000000000F03F00000000000008400000000000000000C7D79E59127037C00000000000000000C7D79E591270374000000000008046C0C7D79E59127037C00000000000000000C7D79E59127037C00000000000000000C7D79E59127037C00000000000001C400000000000001C400000000000000000C7D79E5912703740000000000000204000000000000020400000000000002040000000000000204000000000008046C0C7D79E591270374000000000008056C0C7D79E591270374000000000008056C0C7D79E59127037C000000000008046C0C7D79E59127037C00000000000000000C7D79E59127037C004000000010000000002040000000309000000030D00000001000000FFFFFFFF000000000A080000000203020003010203".toCharArray());
        byte[] geogWKB = Hex.decodeHex("E6100000020017000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000840000000000000F03F000000000000144000000000000008400000000000001C40000000000000104000000000000008400000000000001C400000000000000840000000000000F03FC7D79E59127037C00000000000000000C7D79E59127037400000000000000000C7D79E59127037C000000000008046C0C7D79E59127037C00000000000000000C7D79E59127037C000000000000000000000000000001C400000000000001C40C7D79E591270374000000000000000000000000000002040000000000000204000000000000020400000000000002040C7D79E591270374000000000008046C0C7D79E591270374000000000008056C0C7D79E59127037C000000000008056C0C7D79E59127037C000000000008046C0C7D79E59127037C0000000000000000004000000010000000002040000000309000000030D00000001000000FFFFFFFF000000000A080000000203020003010203".toCharArray());
        Geometry geomWKT = Geometry.deserialize(geomWKB);
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geomWKT.asTextZM(), geoWKT);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }
    
    @Test
    public void testFullGlobeWkb() throws DecoderException {
        String geoWKT = "FULLGLOBE";
        byte[] geogWKB = Hex.decodeHex("E61000000224000000000000000001000000FFFFFFFFFFFFFFFF0B".toCharArray());
        Geography geogWKT = Geography.deserialize(geogWKB);
        assertEquals(geogWKT.asTextZM(), geoWKT);
    }

    @Test
    public void testPointWkt() throws SQLException {
        beforeEachSetup();
        String geoWKT = "POINT(3 40 5 6)";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "POINT EMPTY";
        testWkt(geoWKT);
    }

    @Test
    public void testLineStringWkt() throws SQLException {
        beforeEachSetup();
        String geoWKT = "LINESTRING(1 0, 0 1, -1 0)";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "LINESTRING EMPTY";
        testWkt(geoWKT);
    }

    @Test
    public void testPolygonWkt() throws SQLException {
        beforeEachSetup();
        String geoWKT = "POLYGON((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1))";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "POLYGON EMPTY";
        testWkt(geoWKT);
    }

    @Test
    public void testMultiPointWkt() throws SQLException {
        beforeEachSetup();
        String geoWKT = "MULTIPOINT((2 3), (7 8 9.5))";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "MULTIPOINT EMPTY";
        testWkt(geoWKT);
    }

    @Test
    public void testMultiLineStringWkt() throws SQLException {
        beforeEachSetup();
        String geoWKT = "MULTILINESTRING((0 2, 1 1), (1 0, 1 1))";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "MULTILINESTRING EMPTY";
        testWkt(geoWKT);
    }

    @Test
    public void testMultiPolygonWkt() throws SQLException {
        beforeEachSetup();
        String geoWKT = "MULTIPOLYGON(((1 1, 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "MULTIPOLYGON EMPTY";
        testWkt(geoWKT);
    }

    @Test
    public void testGeometryCollectionWkt() throws SQLException {
        String geoWKT;
        if (isDenaliOrLater) {
            beforeEachSetup();
            geoWKT = "GEOMETRYCOLLECTION(POINT(3 3 1), LINESTRING(1 0, 0 1, -1 0), CIRCULARSTRING(1 3, 3 5, 4 7, 7 3, 1 3), POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2), (0 0 2, 1 10 3, 1 0 4, 0 0 2), (0 0 2, 1 10 3, 1 0 4, 0 0 2)), MULTIPOINT((2 3), (7 8 9.5)), MULTILINESTRING((0 2, 1 1), (1 0, 1 1)), MULTIPOLYGON(((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1)), ((9 9, 9 10, 10 9, 9 9))), COMPOUNDCURVE(CIRCULARSTRING(1 0 3, 0 1 3, 9 6 3, 8 7 3, -1 0 3), CIRCULARSTRING(-1 0 3, 7 9 3, -10 2 3), (-10 2 3, 77 77 77, 88 88 88, 2 6 4), (2 6 4, 3 3 6, 7 7 1)), CURVEPOLYGON((0 0, 0 0, 0 0, 0 0), COMPOUNDCURVE((0 -23.43778, 0 23.43778), CIRCULARSTRING(0 23.43778, -45 -23.43778, 0 -23.43778)), COMPOUNDCURVE((0 -23.43778, 7 7, 0 23.43778), CIRCULARSTRING(0 23.43778, 8 8, 8 8, -45 23.43778, -90 23.43778), (-90 23.43778, -90 -23.43778), CIRCULARSTRING(-90 -23.43778, -45 -23.43778, 0 -23.43778))), POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2)))";
            testWkt(geoWKT);
        }
        beforeEachSetup();
        geoWKT = "GEOMETRYCOLLECTION EMPTY";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "GEOMETRYCOLLECTION(GEOMETRYCOLLECTION EMPTY)";
        testWkt(geoWKT);
        beforeEachSetup();
        geoWKT = "GEOMETRYCOLLECTION(POINT(3 3 1), GEOMETRYCOLLECTION EMPTY, MULTIPOLYGON(((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1)), EMPTY, EMPTY, ((0 0, 1 1, 2 2, 0 0)), EMPTY), GEOMETRYCOLLECTION EMPTY)";
        testWkt(geoWKT);
    }

    @Test
    public void testCircularStringWkt() throws SQLException {
        if (isDenaliOrLater) {
            beforeEachSetup();
            String geoWKT = "CIRCULARSTRING(2 1 3 4, 1 2 3, 0 7 3, 1 0 3, 2 1 3)";
            testWkt(geoWKT);
            beforeEachSetup();
            geoWKT = "CIRCULARSTRING EMPTY";
            testWkt(geoWKT);
        }
    }

    @Test
    public void testCompoundCurveWkt() throws SQLException {
        if (isDenaliOrLater) {
            beforeEachSetup();
            String geoWKT = "COMPOUNDCURVE(CIRCULARSTRING(1 0 3, 0 1 3, 9 6 3, 8 7 3, -1 0 3), CIRCULARSTRING(-1 0 3, 7 9 3, -10 2 3), (-10 2 3, 77 77 77, 88 88 88, 2 6 4), (2 6 4, 3 3 6, 7 7 1))";
            testWkt(geoWKT);
            beforeEachSetup();
            geoWKT = "COMPOUNDCURVE EMPTY";
            testWkt(geoWKT);
        }
    }
    
    @Test
    public void testCurvePolygonWkt() throws SQLException {
        if (isDenaliOrLater) {
            beforeEachSetup();
            String geoWKT = "CURVEPOLYGON((0 0, 0 0, 0 0, 0 0), CIRCULARSTRING(1 3, 3 5, 4 7, 7 3, 1 3), COMPOUNDCURVE((0 -23.43778, 0 23.43778), CIRCULARSTRING(0 23.43778, -45 -23.43778, 0 -23.43778)), COMPOUNDCURVE((0 -23.43778, 7 7, 0 23.43778), CIRCULARSTRING(0 23.43778, 8 8, 8 8, -45 23.43778, -90 23.43778), (-90 23.43778, -90 -23.43778), CIRCULARSTRING(-90 -23.43778, -45 -23.43778, 0 -23.43778)))";
            testWkt(geoWKT);
            beforeEachSetup();
            geoWKT = "CURVEPOLYGON EMPTY";
            testWkt(geoWKT);
        }
    }
    
    @Test
    public void testFullGlobeWkt() throws SQLException {
        if (isDenaliOrLater) {
            beforeEachSetup();
            
            String geoWKT = "FULLGLOBE";
            Geography geogWKT = Geography.STGeomFromText(geoWKT, 4326);

            try {
                Geometry.STGeomFromText(geoWKT, 0);
            }
            catch (IllegalArgumentException e) {
                assertEquals(e.getMessage(), "Fullglobe is not supported for Geometry.");
            }
            
            pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geogTableName + " values (?)");  
            pstmt.setGeography(1, geogWKT);
            pstmt.execute();
            
            rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geogTableName);
            rs.next();
            assertEquals(rs.getGeography(1).asTextZM(), geoWKT);
        }
    }
    
    @Test
    public void testIrregularCases() throws SQLException {
        beforeEachSetup();
        
        String geoWKT = "  GeOMETRyCOLlECTION(POINT(       3e2  2E1 1  ), GEOMETRYCOLLECTION  EmPTy  , GeometryCollection(GEometryCOLLEction(GEometryCOLLEction Empty)), "
                + "POLYGON(  (0 0 2,   1 10 3, 1 0 4,   0 0 2))  )";
        String geoWKTSS = "GEOMETRYCOLLECTION(POINT(300 20 1), GEOMETRYCOLLECTION EMPTY, GEOMETRYCOLLECTION(GEOMETRYCOLLECTION(GEOMETRYCOLLECTION EMPTY)), POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2)))";
        
        testWkt(geoWKT, geoWKTSS);
    }
    
    @Test
    public void testIllegalCases() throws SQLException {
        //Not enough closing bracket case
        String geoWKT = "MULTIPOLYGON(((1 1, 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Reached unexpected end of WKT. Please make sure WKT is valid.");
        }
        
        //Not enough closing and opening bracket case
        geoWKT = "MULTIPOLYGON((1 1, 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 14");
        }
        
        //Too many closing bracket
        geoWKT = "MULTIPOLYGON(((1 1, 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9))))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 91");
        }
        
        //Too many opening bracket
        geoWKT = "MULTIPOLYGON((((1 1, 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 15");
        }
        
        //Too many coordinates
        geoWKT = "MULTIPOLYGON(((1 1 3 4 5, 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 23");
        }
        
        //Too little coordinates
        geoWKT = "MULTIPOLYGON(((1 , 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 17");
        }
        
        //Incorrect data type
        geoWKT = "IvnalidPolygon(((1 , 1 2, 2 1, 1 1), (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 14");
        }
        
        // too many commas
        geoWKT = "MULTIPOLYGON(((1 1, 1 2, 2 1, 1 1),, (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";

        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 35");
        }
        
        // too little commas
        geoWKT = "MULTIPOLYGON(((1 1, 1 2, 2 1, 1 1) (0 0, 0 3, 3 3, 3 0, 0 0 7)), ((9 9, 9 10, 10 9, 9 9)))";
        
        try {
            testWkt(geoWKT);
        }
        catch (IllegalArgumentException e) {
            assertEquals(e.getMessage(), "Illegal character at wkt position 35");
        }
    }
    
    @Test
    public void testAllTypes() throws SQLException {
        if (isDenaliOrLater) {
            beforeEachSetup();
            
            String geoWKTPoint = "POINT(30 12.12312312 5 6)";
            String geoWKTLineString = "LINESTRING(1 1, 2 4 3, 3 9 123 332)";
            String geoWKTCircularString = "CIRCULARSTRING(1 1, 2 4, 3 9)";
            String geoWKTCompoundCurve = "COMPOUNDCURVE((1 1, 1 3), (1 3, 3 3), (3 3, 3 1), (3 1, 1 1))";
            String geoWKTCurvePolygon = "CURVEPOLYGON(CIRCULARSTRING(2 4, 4 2, 6 4, 4 6, 2 4))";
            String geoWKTPolygon = "POLYGON((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1))";
            String geoWKTMultiPoint = "MULTIPOINT((2 3), (7 8 9.5))";
            String geoWKTMultiLineString = "MULTILINESTRING((0 2, 1 1), (1 0, 1 1))";
            String geoWKTMultiPolygon = "MULTIPOLYGON(((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1)), ((9 9, 9 10, 10 9, 9 9)))";
            String geoWKTGeometryCollection = "GEOMETRYCOLLECTION(POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2)), POINT(3 3 1 2.5), LINESTRING(1 0, 0 1, -1 0), GEOMETRYCOLLECTION(GEOMETRYCOLLECTION(POINT(1 2 3 4))), GEOMETRYCOLLECTION(GEOMETRYCOLLECTION EMPTY), CURVEPOLYGON((0 0, 0 0, 0 0, 0 0), CIRCULARSTRING(1 3, 3 5, 4 7, 7 3, 1 3), COMPOUNDCURVE((0 -23.43778, 0 23.43778), CIRCULARSTRING(0 23.43778, -45 -23.43778, 0 -23.43778)), COMPOUNDCURVE((0 -23.43778, 7 7, 0 23.43778), CIRCULARSTRING(0 23.43778, 8 8, 8 8, -45 23.43778, -90 23.43778), (-90 23.43778, -90 -23.43778), CIRCULARSTRING(-90 -23.43778, -45 -23.43778, 0 -23.43778))))";
            
            List<String> geoWKTList = new ArrayList<String>();
            
            geoWKTList.add(geoWKTPoint);
            geoWKTList.add(geoWKTLineString);
            geoWKTList.add(geoWKTCircularString);
            geoWKTList.add(geoWKTCompoundCurve);
            geoWKTList.add(geoWKTCurvePolygon);
            geoWKTList.add(geoWKTPolygon);
            geoWKTList.add(geoWKTMultiPoint);
            geoWKTList.add(geoWKTMultiLineString);
            geoWKTList.add(geoWKTMultiPolygon);
            geoWKTList.add(geoWKTGeometryCollection);
            
            Geometry geomWKT;
            Geography geogWKT;
            
            //Geometry
            pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geomTableName + " values (?)");    
            
            geomWKT = Geometry.STGeomFromText(geoWKTPoint, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTLineString, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTCircularString, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTCompoundCurve, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTCurvePolygon, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTPolygon, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTMultiPoint, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTMultiLineString, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTMultiPolygon, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTGeometryCollection, 0);
            pstmt.setGeometry(1, geomWKT);
            pstmt.executeUpdate();
            
            rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geomTableName);
            for (int i = 0; i < geoWKTList.size(); i++) {
                rs.next();
                assertEquals(rs.getGeometry(1).asTextZM(), geoWKTList.get(i));
            }
            
            //Geography
            pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geogTableName + " values (?)");    
            
            geogWKT = Geography.STGeomFromText(geoWKTPoint, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTLineString, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTCircularString, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTCompoundCurve, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTCurvePolygon, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTPolygon, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTMultiPoint, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTMultiLineString, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTMultiPolygon, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            geogWKT = Geography.STGeomFromText(geoWKTGeometryCollection, 4326);
            pstmt.setGeography(1, geogWKT);
            
            pstmt.executeUpdate();
            
            rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geogTableName);
            for (int i = 0; i < geoWKTList.size(); i++) {
                rs.next();
                assertEquals(rs.getGeography(1).asTextZM(), geoWKTList.get(i));
            }
        }
    }
    
    @Test
    public void testMixedAllTypes() throws SQLException {
        if (isDenaliOrLater) {
            beforeEachSetupSpatialDatatype();
            
            String geoWKTPoint = "POINT(30 12.12312312 5 6)";
            String geoWKTLineString = "LINESTRING(1 1, 2 4 3, 3 9 123 332)";
            String geoWKTCircularString = "CIRCULARSTRING(1 1, 2 4, 3 9)";
            String geoWKTCompoundCurve = "COMPOUNDCURVE((1 1, 1 3), (1 3, 3 3), (3 3, 3 1), (3 1, 1 1))";
            String geoWKTCurvePolygon = "CURVEPOLYGON(CIRCULARSTRING(2 4, 4 2, 6 4, 4 6, 2 4))";
            String geoWKTPolygon = "POLYGON((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1))";
            String geoWKTMultiPoint = "MULTIPOINT((2 3), (7 8 9.5))";
            String geoWKTMultiLineString = "MULTILINESTRING((0 2, 1 1), (1 0, 1 1))";
            String geoWKTMultiPolygon = "MULTIPOLYGON(((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 1 2, 2 1, 1 1)), ((9 9, 9 10, 10 9, 9 9)))";
            String geoWKTGeometryCollection = "GEOMETRYCOLLECTION(POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2)), POINT(3 3 1 2.5), LINESTRING(1 0, 0 1, -1 0), GEOMETRYCOLLECTION(GEOMETRYCOLLECTION(POINT(1 2 3 4))), GEOMETRYCOLLECTION(GEOMETRYCOLLECTION EMPTY), CURVEPOLYGON((0 0, 0 0, 0 0, 0 0), CIRCULARSTRING(1 3, 3 5, 4 7, 7 3, 1 3), COMPOUNDCURVE((0 -23.43778, 0 23.43778), CIRCULARSTRING(0 23.43778, -45 -23.43778, 0 -23.43778)), COMPOUNDCURVE((0 -23.43778, 7 7, 0 23.43778), CIRCULARSTRING(0 23.43778, 8 8, 8 8, -45 23.43778, -90 23.43778), (-90 23.43778, -90 -23.43778), CIRCULARSTRING(-90 -23.43778, -45 -23.43778, 0 -23.43778))))";
            
            String s = "some string";
            Double d = 31.34;
            int i2 = 5;
            
            List<String> geoWKTList = new ArrayList<String>();
            
            geoWKTList.add(geoWKTPoint);
            geoWKTList.add(geoWKTLineString);
            geoWKTList.add(geoWKTCircularString);
            geoWKTList.add(geoWKTCompoundCurve);
            geoWKTList.add(geoWKTCurvePolygon);
            geoWKTList.add(geoWKTPolygon);
            geoWKTList.add(geoWKTMultiPoint);
            geoWKTList.add(geoWKTMultiLineString);
            geoWKTList.add(geoWKTMultiPolygon);
            geoWKTList.add(geoWKTGeometryCollection);
            
            Geometry geomWKT;
            Geography geogWKT;
            
            pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ spatialDatatypeTableName + " values (?, ?, ?, ?, ?)");    
            
            geomWKT = Geometry.STGeomFromText(geoWKTPoint, 0);
            geogWKT = Geography.STGeomFromText(geoWKTPoint, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTLineString, 0);
            geogWKT = Geography.STGeomFromText(geoWKTLineString, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTCircularString, 0);
            geogWKT = Geography.STGeomFromText(geoWKTCircularString, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTCompoundCurve, 0);
            geogWKT = Geography.STGeomFromText(geoWKTCompoundCurve, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTCurvePolygon, 0);
            geogWKT = Geography.STGeomFromText(geoWKTCurvePolygon, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();

            geomWKT = Geometry.STGeomFromText(geoWKTPolygon, 0);
            geogWKT = Geography.STGeomFromText(geoWKTPolygon, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTMultiPoint, 0);
            geogWKT = Geography.STGeomFromText(geoWKTMultiPoint, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTMultiLineString, 0);
            geogWKT = Geography.STGeomFromText(geoWKTMultiLineString, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTMultiPolygon, 0);
            geogWKT = Geography.STGeomFromText(geoWKTMultiPolygon, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            geomWKT = Geometry.STGeomFromText(geoWKTGeometryCollection, 0);
            geogWKT = Geography.STGeomFromText(geoWKTGeometryCollection, 4326);
            pstmt.setGeometry(1, geomWKT);
            pstmt.setGeography(2, geogWKT);
            pstmt.setString(3, s);
            pstmt.setDouble(4, d);
            pstmt.setInt(5, i2);
            
            pstmt.executeUpdate();
            
            rs = (SQLServerResultSet) stmt.executeQuery("select * from " + spatialDatatypeTableName);
            for (int i = 0; i < geoWKTList.size(); i++) {
                rs.next();
                assertEquals(rs.getGeometry(1).asTextZM(), geoWKTList.get(i));
                assertEquals(rs.getGeography(2).asTextZM(), geoWKTList.get(i));
                assertEquals(rs.getString(3), s);
                assertEquals((Double) rs.getDouble(4), d);
                assertEquals(rs.getInt(5), i2);
            }
        }
    }

    @Test
    public void testDecimalRounding() throws SQLException {
        beforeEachSetup();
        
        String geoWKT = "POINT(3 40.7777777777777777777 5 6)";
        String geoWKTSS = "POINT(3 40.77777777777778 5 6)";
        
        testWkt(geoWKT, geoWKTSS);
    }
    
    @Test
    public void testParse() throws SQLException {
        beforeEachSetup();
        
        String geoWKT = "GEOMETRYCOLLECTION(POINT(300 20 1), GEOMETRYCOLLECTION EMPTY, GEOMETRYCOLLECTION(GEOMETRYCOLLECTION(GEOMETRYCOLLECTION EMPTY)), POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2)))";
        
        Geometry geomWKT = Geometry.parse(geoWKT);
        Geography geogWKT = Geography.parse(geoWKT);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geomTableName + " values (?)");    
        pstmt.setGeometry(1, geomWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geomTableName);
        rs.next();
        assertEquals(rs.getGeometry(1).asTextZM(), geoWKT);
        assertEquals(rs.getGeometry(1).getSrid(), 0);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geogTableName + " values (?)");  
        pstmt.setGeography(1, geogWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geogTableName);
        rs.next();
        assertEquals(rs.getGeography(1).asTextZM(), geoWKT);
        assertEquals(rs.getGeography(1).getSrid(), 4326);
    }
    
    @Test
    public void testPoint() throws SQLException {
        beforeEachSetup();
        
        String geoWKT = "POINT(1 2)";
        
        Geometry geomWKT = Geometry.point(1, 2, 0);
        Geography geogWKT = Geography.point(1, 2, 4326);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geomTableName + " values (?)");    
        pstmt.setGeometry(1, geomWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geomTableName);
        rs.next();
        assertEquals(rs.getGeometry(1).asTextZM(), geoWKT);
        assertEquals(rs.getGeometry(1).getSrid(), 0);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geogTableName + " values (?)");  
        pstmt.setGeography(1, geogWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geogTableName);
        rs.next();
        assertEquals(rs.getGeography(1).asTextZM(), geoWKT);
        assertEquals(rs.getGeography(1).getSrid(), 4326);
    }
    
    @Test
    public void testSTAsText() throws SQLException {
        beforeEachSetup();
        
        String geoWKT = "GEOMETRYCOLLECTION(POINT(300 20 1), GEOMETRYCOLLECTION EMPTY, GEOMETRYCOLLECTION(GEOMETRYCOLLECTION(GEOMETRYCOLLECTION EMPTY)), POLYGON((0 0 2, 1 10 3, 1 0 4, 0 0 2)))";
        String geoWKTSS = "GEOMETRYCOLLECTION(POINT(300 20), GEOMETRYCOLLECTION EMPTY, GEOMETRYCOLLECTION(GEOMETRYCOLLECTION(GEOMETRYCOLLECTION EMPTY)), POLYGON((0 0, 1 10, 1 0, 0 0)))";
        
        Geometry geomWKT = Geometry.STGeomFromText(geoWKT, 0);
        Geography geogWKT = Geography.STGeomFromText(geoWKT, 4326);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geomTableName + " values (?)");    
        pstmt.setGeometry(1, geomWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geomTableName);
        rs.next();
        assertEquals(rs.getGeometry(1).STAsText(), geoWKTSS);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geogTableName + " values (?)");  
        pstmt.setGeography(1, geogWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geogTableName);
        rs.next();
        assertEquals(rs.getGeography(1).STAsText(), geoWKTSS);
    }
    
    @Test
    public void testSTAsBinary() throws SQLException {
        beforeEachSetup();
        
        String geoWKT = "POINT(3 40 5 6)";
        String geoWKT2 = "POINT(3 40)";
        
        Geometry geomWKT = Geometry.STGeomFromText(geoWKT, 0);
        Geography geogWKT = Geography.STGeomFromText(geoWKT, 4326);
        
        byte[] geomWKB = geomWKT.STAsBinary();
        byte[] geogWKB = geogWKT.STAsBinary();
        
        Geometry geomWKT2 = Geometry.STGeomFromText(geoWKT2, 0);
        Geography geogWKT2 = Geography.STGeomFromText(geoWKT2, 4326);
        
        byte[] geomWKB2 = geomWKT2.STAsBinary();
        byte[] geogWKB2 = geogWKT2.STAsBinary();
        
        assertEquals(geomWKB, geomWKB2);
        assertEquals(geogWKB, geogWKB2);
    }

    public void testCheckGeomMetaData() throws SQLException {
        beforeEachSetup();
                
        pstmt = (SQLServerPreparedStatement) connection.prepareStatement("INSERT INTO " + geomTableName +" (c1) VALUES (?)");
        ParameterMetaData paramMetaData = pstmt.getParameterMetaData();
        Geometry g = Geometry.STGeomFromText("POINT (1 2 3 4)", 0);
        pstmt.setGeometry(1, g);
        pstmt.execute();
        
        int sqlType = paramMetaData.getParameterType(1);
        String sqlTypeName = paramMetaData.getParameterTypeName(1);
        assertEquals(sqlType, -157);
        assertEquals(sqlTypeName, "geometry");
        SQLServerResultSet rs = (SQLServerResultSet) stmt.executeQuery("select * from " + geomTableName);
        ResultSetMetaData rsmd = rs.getMetaData();
        assertEquals(rsmd.getColumnType(1), -157);
    }
    
    @Test
    public void testCheckGeogMetaData() throws SQLException {
        beforeEachSetup();
        
        pstmt = (SQLServerPreparedStatement) connection.prepareStatement("INSERT INTO " + geogTableName +" (c1) VALUES (?)");
        ParameterMetaData paramMetaData = pstmt.getParameterMetaData();
        Geography g = Geography.STGeomFromText("POINT (1 2 3 4)", 4326);
        pstmt.setGeography(1, g);
        pstmt.execute();
        
        int sqlType = paramMetaData.getParameterType(1);
        String sqlTypeName = paramMetaData.getParameterTypeName(1);
        assertEquals(sqlType, -158);
        assertEquals(sqlTypeName, "geography");
        SQLServerResultSet rs = (SQLServerResultSet) stmt.executeQuery("select * from " + geogTableName);
        ResultSetMetaData rsmd = rs.getMetaData();
        assertEquals(rsmd.getColumnType(1), -158);
    }
    
    private void beforeEachSetup() throws SQLException {
        Utils.dropTableIfExists(geomTableName, stmt);
        Utils.dropTableIfExists(geogTableName, stmt);
        stmt.executeUpdate("Create table " + geomTableName + " (c1 geometry)");
        stmt.executeUpdate("Create table " + geogTableName + " (c1 geography)");
    }
    
    private void beforeEachSetupSpatialDatatype() throws SQLException {
        Utils.dropTableIfExists(spatialDatatypeTableName, stmt);
        stmt.executeUpdate("Create table " + spatialDatatypeTableName + 
                " (c1 geometry,"
                + "c2 geography,"
                + "c3 nvarchar(512),"
                + "c4 decimal(28,4),"
                + "c5 int)");
    }
    
    private void testWkt(String geoWKT) throws SQLException {
        testWkt(geoWKT, geoWKT);
    }
    
    private void testWkt(String geoWKT, String geoWKTSS) throws SQLException {
        Geometry geomWKT = Geometry.STGeomFromText(geoWKT, 0);
        Geography geogWKT = Geography.STGeomFromText(geoWKT, 4326);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geomTableName + " values (?)");    
        pstmt.setGeometry(1, geomWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geomTableName);
        rs.next();
        assertEquals(rs.getGeometry(1).asTextZM(), geoWKTSS);
        
        pstmt = (SQLServerPreparedStatement) con.prepareStatement("insert into "+ geogTableName + " values (?)");  
        pstmt.setGeography(1, geogWKT);
        pstmt.execute();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select c1 from " + geogTableName);
        rs.next();
        assertEquals(rs.getGeography(1).asTextZM(), geoWKTSS);
    }
    
    /**
     * Prepare test
     * 
     * @throws SQLException
     * @throws SecurityException
     * @throws IOException
     */
    @BeforeAll
    public static void setupHere() throws SQLException, SecurityException, IOException {
        con = (SQLServerConnection) DriverManager.getConnection(connectionString);
        stmt = con.createStatement();
        
        rs = (SQLServerResultSet) stmt.executeQuery("select SERVERPROPERTY ( 'ProductVersion' )");
        
        rs.next();
        
        try {
            int version = Integer.parseInt(rs.getString(1).substring(0, 2));
            
            // if major version is greater than or equal to 11, it's SQL Server 2012 or above.
            if (version >= 11) {
                isDenaliOrLater = true;
            }
        } catch (Exception e) {
            // Do nothing.
        }
    }

    /**
     * drop the tables
     * 
     * @throws SQLException
     */
    @AfterAll
    public static void afterAll() throws SQLException {
        Utils.dropTableIfExists(geomTableName, stmt);
        Utils.dropTableIfExists(geogTableName, stmt);

        if (null != stmt) {
            stmt.close();
        }

        if (null != pstmt) {
            pstmt.close();
        }

        if (null != rs) {
            rs.close();
        }

        if (null != con) {
            con.close();
        }
    }
}
